<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Add Your recipe!</title>
        <link rel="stylesheet" href="../../static/cooking_app/css/bootstrap.min.css">
        <link rel="stylesheet" href="../../static/cooking_app/css/add.css">
        <script src="../../static/cooking_app/js/jquery-3.1.1.min.js" charset="utf-8"></script>
        <script src="../../static/cooking_app/js/bootstrap.min.js" charset="utf-8"></script>
        {% load staticfiles %}
        <script src="{% static 'cooking_app/js/js.cookie.js' %}"></script>
        <script>
            $(document).ready(function(){
                $('#form form').focusout(function(e){
                    console.log('ran');
                    e.preventDefault()
                    $.post(this.action, $(this).serialize(), function(serverResponse){
                        //TODO: Show errors
                    });
                })
                $('table').on('submit', '#new_step_form', function(e){
                    console.log('add');
                    e.preventDefault();
                        $.post(this.action, $(this).serialize(), function(serverResponse){
                            // $('body').html($(serverResponse).find('body').html());
                            $('body').html(serverResponse);
                        });
                });
                // $('#new_step_form').submit(function(e){
                //     e.preventDefault();
                //     $.post(this.action, $(this).serialize(), function(serverResponse){
                //         $('body').html(serverResponse)
                //     });
                // })
                $('table').on('focusout', '#update_recipe form', function(){
                    $.post(this.action, $(this).serialize(), function(serverResponse){
                        //do nothing
                    });
                })
                // $('#update_recipe form').focusout(function(){
                //     $.post(this.action, $(this).serialize(), function(serverResponse){
                        //do nothing
                //     });
                // })
                //update recipe
                $('table').on('focusout', 'td*', function(){
                    if (!$(this).parent().find('form').hasClass('new_step')){  //test to see if it's updating step
                        $.post($(this).parent().find('form')[0].action, $(this).parent().find('form').serialize(), function(serverResponse){
                            //do nothing with response
                        });
                    }
                });
                // $( "td*" ).focusout(function() {
                //     if (!$(this).parent().find('form').hasClass('new_step')){  //test to see if it's updating step
                //         $.post($(this).parent().find('form')[0].action, $(this).parent().find('form').serialize(), function(serverResponse){
                //             //do nothing with response
                //         });
                //     }
                // });
                //delete step
                $('table').on('click', '.link', function(e){
                    e.preventDefault();
                    $.get($(this).attr('href'), function(serverResponse){
                        $('#tr_'+serverResponse.to_delete).remove();
                    });
                })
                // $('.link').click(function(e){
                //     e.preventDefault();
                //     $.get($(this).attr('href'), function(serverResponse){
                //         $('#tr_'+serverResponse.to_delete).remove();
                //     });
                // });
            });
        </script>
    </head>
    <body>
        <div class="container">
            <div class="container-fluid">
                <nav id="mainNav" class="navbar navbar-default navbar-fixed-top">
                    <div class="container-fluid">
                        <div class="navbar-header">
                            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                                <span class="sr-only">Toggle navigation</span> Menu <i class="fa fa-bars"></i>
                            </button>
                            <a class="navbar-brand" href="{% url 'main:index' %}"><img src="../../static/cooking_app/images/gold1.png" alt=""></a>
            				<p class='navbar-text navbar-left'>Hello, {{user.first_name}}!</p>
                        </div>
                        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                            <ul class="nav navbar-nav navbar-right">
                                <li><a href="{% url 'main:index' %}">Home</a></li>
                                <li><a href="{% url 'main:show_user' id=request.session.id %}">Profile</a></li>
                                <li><a href="{% url 'main:add_recipe' %}">Add a Recipe</a></li>
                                <li><a href="{% url 'main:search' %}">Search</a></li>
                                <li><a href="{% url 'loginReg:logout' %}">Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </nav>
                <div class="main">
                    <div id="header">
                        <h1>Edit your Recipe!</h1>
                        <p class='para'>Here you are able to edit you're own recipe and add anything that you may have missed!</p>
                    </div>

                    {% if messages %}
                        {% for message in messages %}
                            <p{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</p>
                        {% endfor %}
                    {% endif %}

                    <div id="update_recipe">
                        <div id="form">
                            <form action="{% url 'main:edit_recipe' recipe_id=recipe.id%}" method="post" class='form-horizontal edit'>
                                {% csrf_token %}
                                <div class="form-group">
                                    <label>Recipe Title: <input type="text" name="title" value="{{recipe.title}}" class='form-control'></label>
                                </div>
                                <div class="form-group">
                                    <label>Prep Time: <input type="number" name="prep_time_hour" value="{{recipe.prep_time_hour}}" min="0" class='form-control inline time'> hrs </label>
                                    <label><input type="number" name="prep_time_minute" value="{{recipe.prep_time_minute}}" min="0" class='form-control inline time'> min</label><br>
                                </div>
                                <div class="form-group">
                                    <label>Cook Time: <input type="number" name="cook_time_hour" value="{{recipe.cook_time_hour}}" min="0" class='form-control inline time'> hrs</label>
                                    <label><input type="number" name="cook_time_minute" value="{{recipe.cook_time_minute}}" min="0" class='form-control inline time'> min</label><br>
                                </div>
                                <div class="form-group">
                                    <label><span class="vert_align">Description:</span> <textarea name="description" rows="3" cols="25" class='form-control'>{{recipe.description}}</textarea></label><br>
                                </div>
                                <div class="form-group">
                                    <p><label>Categories:</label></p>
                                    {% for category in categories %}
                                        {% if category in recipe.categories.all %}
                                            <input class='checkbox inline' type="checkbox" name="{{category.category}}" value="{{category.id}}" checked> {{category.category}}
                                        {% else %}
                                            <input class='checkbox inline' type="checkbox" name="{{category.category}}" value="{{category.id}}"> {{category.category}}
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </form>
                            <a href="{% url 'main:delete_recipe' recipe_id=recipe.id %}"><button class='btn btn-danger'>Delete Recipe</button></a> <a href="{% url 'main:show_recipe' recipe_id=recipe.id %}"><button class='btn btn-success'>View Recipe</button></a>
                            <div class="foodpic">
                                {% if recipe.recipe_image %}
                                    <img id="recipe_img" class='img-responsive' src="/{{recipe.recipe_image.image.url}}">
                                {% endif %}
                            </div>
                        </div>
                        <!-- add form to update food pic -->
                        <!--         <form enctype="multipart/form-data" action="{% url 'main:edit_recipe' recipe_id=recipe.id %}" method="post">
                        {% csrf_token %}
                        <label>Change Image: <input type="file" name="image"></label><br>
                        <input type="submit" value="Update Image">
                        </form> -->
                    </div>
                    <hr>
                    <div id="steps">
                        <h3>Update your steps</h3>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Step #</th>
                                    <th>Measurement</th>
                                    <th>Ingredient</th>
                                    <th>Description</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for step in recipe.steps.all %}
                                    <tr id='tr_{{step.id}}'>
                                        <form id='{{step.id}}' class='update_step form-horizontal' action="{% url 'main:update_step' step_id=step.id%}" method="post">
                                            {% csrf_token %}
                                            <td>{{ forloop.counter }}</td>
                                            <td>
                                                <select name='measurement'>
                                                    {% for measurement in measurements %}
                                                        {% if measurement ==  step.measurement %}
                                                            <option selected="selected" value="{{measurement.id}}">{{measurement.measurement}}</option>
                                                        {% else %}
                                                            <option value="{{measurement.id}}">{{measurement.measurement}}</option>
                                                        {% endif %}
                                                    {% endfor %}
                                                </select>
                                                <input type="text" name="new_measurement" placeholder="Add new measurement" class='form-control'>
                                            </td>
                                            <td>
                                                <select name='ingredient'>
                                                    {% for ingredient in ingredients %}
                                                        {% if ingredient == step.ingredient %}
                                                            <option selected="selected" value="{{ingredient.id}}">{{ingredient.ingredient}}</option>
                                                        {% else %}
                                                            <option value="{{ingredient.id}}">{{ingredient.ingredient}}</option>
                                                        {% endif %}
                                                    {% endfor %}
                                                </select>
                                                <input type="text" name="new_ingredient" placeholder="Add new ingredient" class='form-control'>
                                            </td>
                                            <td>
                                                <textarea name="description" rows="2" cols="25" class='form-control'>{{step.description}}</textarea></label>
                                                <input type="hidden" name="step_id" value="{{step.id}}">
                                            </td>
                                            <td>
                                                <a class='link' href="{% url 'main:delete_step' step_id=step.id %}"><button class='btn btn-danger'>Delete Step</button></a>
                                            </td>
                                        </tr>
                                    </form>
                                {% endfor %}

                                <tr>
                                    <form id='new_step_form' class='new_step form-horizontal' action="{% url 'main:add_step' %}" method="post">
                                        {% csrf_token %}
                                        <td>Add New</td>
                                        <td>
                                            <select name='measurement'>
                                                {% for measurement in measurements %}
                                                    <option value="{{measurement.id}}">{{measurement.measurement}}</option>
                                                {% endfor %}
                                            </select>
                                            <input type="text" name="new_measurement" placeholder="Add new measurement" class='form-control'>
                                        </td>
                                        <td>
                                            <select name='ingredient'>
                                                {% for ingredient in ingredients %}
                                                    <option value="{{ingredient.id}}">{{ingredient.ingredient}}</option>
                                                {% endfor %}
                                            </select>
                                            <input type="text" name="new_ingredient" placeholder="Add new ingredient" class='form-control'>
                                        </td>
                                        <td>
                                            <textarea name="description" rows="2" cols="25" class='form-control'></textarea>
                                            <input type="hidden" name="recipe_id" value="{{recipe.id}}">
                                        </td>
                                        <td>
                                            <div class="form-group">
                                                <input type="submit" value="Add Step" class='btn btn-success'>
                                            </div>
                                        </td>
                                    </form>
                                </tr>
                            </tbody>
                        </table>
                        <h1>NEED TO FINISH IMPLIMENTING ADD. IT BEAKS AFTER ONE ADD</h1>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>










<!--  -->
